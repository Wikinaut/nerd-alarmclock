var settings;  // FIXME(benjaminfuchs) Better way than a global variable?
list_of_days = {
         "monday"   : 1,
         "tuesday"  : 2,
         "wednesday": 3,
         "thursday" : 4,
         "friday"   : 5,
         "saturday" : 6,
         "sunday"   : 7
         };

// Get settings via API call.
$(document).ready(function() {
  console.log("Getting settings via API.");
  $.ajax({
      url: "/get_settings"
  }).then(function(data) {
      settings = data;
      set_settings();
  });
});

// Get sounds via API call.
$(document).ready(function() {
  console.log("Getting sounds via API.");
  $.ajax({
    url: "/get_sounds"
  }).then(function(data) {
    var select = document.getElementById("select_sound");
    var options = data;
    for(var i = 0; i < options.length; i++) {
      var opt = options[i];
      var el = document.createElement("option");
      if ( opt == settings["alarm.1.sound"]["name"] ) {
        el.selected = "selected";
      }
      el.textContent = opt.replace(/\.[^/.]+$/, "");
      el.className = "dropdown-content";
      el.value = opt;
      select.appendChild(el);
    }
  });
});

function set_settings() {
  document.getElementById("alarm_time").value = settings["alarm.1.time"];
  if (settings["alarm.1.state"] == "enabled") {
    document.getElementById("alarm_state").checked = true;
  }
  set_days(settings["alarm.1.days"]);
}

function set_days(array_of_days) {
  for (var day in list_of_days) {
    if (array_of_days.indexOf(list_of_days[day]) != -1) {
      document.getElementById(day).checked = true;
    }
  }
}

function get_days() {
  var array_of_days = [];
  for (var day in list_of_days) {
    if (document.getElementById(day).checked) {
      array_of_days.push(list_of_days[day]);
    }
  }
  return array_of_days;
}

function get_sound() {
  var e = document.getElementById("select_sound");
  return e.options[e.selectedIndex].value;
}

// Get settings from webinterface.
function get_settings() {
    console.log("Getting settings from webinterface.")
    settings["alarm.1.time"] = document.getElementById("alarm_time").value;
    if (document.getElementById("alarm_state").checked) {
      settings["alarm.1.state"] = "enabled";
    } else {
      settings["alarm.1.state"] = "disabled"
    }
    if (document.getElementById("alarm_state").checked) {
      settings["alarm.1.state"] = "enabled";
    } else {
      settings["alarm.1.state"] = "disabled"
    }
    settings["alarm.1.days"] = get_days();
    settings["alarm.1.sound"]["name"] = get_sound();
}

// Update time via API call.
function update_alarm() {
    console.log("Updating alarm settings.");
    var xhttp = new XMLHttpRequest();

    get_settings();
    xhttp.open("POST", "/save_settings", true);
    xhttp.send(JSON.stringify(settings));
}

// Update settings before leaving pate.
$(window).bind('beforeunload', function(){
    console.log("Updating alarm with current settings before leaving page.");
    update_alarm();
});
