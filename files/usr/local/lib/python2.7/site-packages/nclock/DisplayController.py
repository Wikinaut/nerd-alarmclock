#!/usr/bin/python
# --------------------------------------------------------------------------
# Class definition of DisplayController - utility functions for the
# segment display.
#
# Please edit /etc/nerd-alarmclock.conf to configure this thread
#
# Author: Bernhard Bablok
# License: GPL3
#
# Website: https://github.com/bablokb/nerd-alarmclock
#
# --------------------------------------------------------------------------

import time, threading, colorsys

simulate=False
try:
  import fourletterphat as display
except:
  # we assume our test-environment
  simulate=True

class DisplayController(object):
  """ Utility functions for the segment-display """

  # initialize object   ----------------------------------------------------

  def __init__(self,settings):
    """ Constructor """
    self._settings = settings
    self._lock     = threading.Lock()

    # set display and brightness
    self._initialize()

    settings.add_settings_listener('display_brightness_day',self.on_brightness)
    settings.add_settings_listener('display_brightness_night',self.on_brightness)
    settings.add_settings_listener('alarm1',self.on_alarm)
    settings.add_settings_listener('alarm2',self.on_alarm)
    settings.add_settings_listener('alarm3',self.on_alarm)
    settings.add_settings_listener('alarm4',self.on_alarm)
    settings.add_timechange_listener(self.on_time)

  # --- initialize the display (brightness, time)   ------------------------

  def _initialize(self):
    """ Initialize time and brightness """

    # query and initialize alarms
    self._alarms = []
    for i in range(4):
      alarm = self._settings.get("alarm"+str(i+1))
      self._alarms[i] = alarm.state != "disabled"

    # initialize time-display (including alarm-indicator)
    self._current_time = time.strftime("%H:%M")
    self.set_time()

    day_start = self._settings.get("day_start")
    day_end   = self._settings.get("day_end")

    if day_start <= self._current_time and self._current_time <= day_end:
      self.set_brightness(self._settings.get("display_brightness_day"))
    else:
      self.set_brightness(self._settings.get("display_brightness_night"))

  # --- set the time   -----------------------------------------------------

  def set_time(self,t=None):
    """ show the given or current time on the display """
    if t:
      t_string = t[0:2] + t[3:5]
    else:
      t_string = self._current_time[0:2] + self._current_time[3:5]

    self._settings.log.msg("Setting time to: %s" % t_string)
    if not simulate:
      with self._lock:
        display.clear()
        display.print_str(t_string)
        display.show()

      for i in range(4):
        self._set_decimal(i,self._alarms[i])

  # --- set the brightness of the display   --------------------------------

  def set_brightness(self,value):
    """ Set the brightness of the display """
    # we only use off and four levels, so scale new appropriately
    self._settings.log.msg("Setting brightness to: %d" % value)
    if not simulate:
      with self._lock:
        display.set_brightness(min(4*value,15))
        display.show()

  # --- display a text for the given time   --------------------------------

  def show_text(self,text,duration=2,blink=True):
    if simulate:
      self._settings.log.msg("showing text: %s" % text)
      time.sleep(duration)
    else:
      with self._lock:
        display.clear()
        display.print_str(text)
        if blink:
          display.set_blink(display.HT16K33_BLINK_2HZ)
        display.show()
        time.sleep(duration)
        if blink:
          display.set_blink(display.HT16K33_BLINK_OFF)

      # now reset to old state
      self.set_time()

  # --- time change listener   ---------------------------------------------

  def scroll_text(self,text,duration=2):
    if simulate:
      self._settings.log.msg("scrolling text: %s" % text)
      time.sleep(duration)
    else:
      with self._lock:
        display.clear()
        display.scroll_text(text,duration)
        display.show()

      # now reset to old state
      self.set_time()

  # --- time change listener   ---------------------------------------------

  def on_time(self,old,new):
    """ process time-change events (update time)"""
    self._current_time = new
    self._settings.log.msg("DisplayController.on_time(%s,%s)" % (old,new))
    self.set_time()

  # --- brightness change listener   ---------------------------------------

  def on_brightness(self,old,new):
    """ process brightness-changes """

    self._settings.log.msg("DisplayController.on_brightness(%s,%s)" % (old,new))
    self.set_brightness(new)

  # --- alarm change listener   -------------------------------------------

  def on_alarm(self,old,new):
    """ process alarm changes: set or unset decimal """

    self._settings.log.msg("Changing state of alarm %s from %s to %s" %
                           (new.nr,old.state,new.state))
    state = new.state != "disabled"
    index = int(new.nr)-1
    self._alarms[index] = state      # keep state, so set_time works
    self._set_decimal(index,state)

  # --- set decimal   ------------------------------------------------------

  def _set_decimal(self,index,state):
    if not simulate:
      with self._lock:
        display.set_decimal(index,state)
        display.show()
    
