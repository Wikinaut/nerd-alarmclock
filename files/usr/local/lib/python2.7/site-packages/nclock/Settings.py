#!/usr/bin/python
# --------------------------------------------------------------------------
# Class definition of Settings - a value holder class
#
# Author: Bernhard Bablok
# License: GPL3
#
# Website: https://github.com/bablokb/nerd-alarmclock
#
# --------------------------------------------------------------------------

import os, json
from threading import Lock, Event

# --- value holder for alarm-settings   ------------------------------------

class Alarm(object):
  """ Value-holder for alarm settings """

  def __init__(self,jsonobj):
    """ Constructor (create object from JSON) """
    self.nr    = jsonobj["nr"]
    self.name  = jsonobj["name"]
    self.state = jsonobj["state"]
    self.time  = jsonobj["time"]
    self.days  = jsonobj["days"]
    self.bell1 = jsonobj["bell1"]
    self.bell2 = jsonobj["bell2"]

  def toJSON(self):
    """ create JSON-structure of object """
    obj = {
      "nr":    self.nr,
      "name":  self.name,
      "state": self.state,
      "time":  self.time,
      "days":  self.days,
      "bell1": self.bell1,
      "bell2": self.bell2
      }
    return obj

# --- Value holder for shared settings   -----------------------------------

class Settings(object):
  """ Object with shared settings """

  # initialize object   ----------------------------------------------------

  def __init__(self,parser):
    """ Constructor """

    # public fields
    self.config_parser = parser
    self.debug = self.get_value('GLOBAL','debug','0')
    self.stop_event = Event()
    self.time_change_listener = []             # calls backs for time change

    # private fields
    default_store  = os.path.join(os.path.expanduser("~"),".nerdclock.json")
    self._store    = self.get_value('GLOBAL','store',default_store)
    self._values   = {}
    self._listener = {}
    self._lock     = Lock()

  # --- read a configuration value   -----------------------------------------

  def get_value(self,section,option,default):
    """ get value of config-variabele and return given default if unset """

    if self.config_parser.has_section(section):
      try:
        value = self.config_parser.get(section,option)
      except:
        value = default
    else:
      value = default
    return value

  # --- load settings   ----------------------------------------------------

  def load(self):
    self.log.msg("Loading settings from %s" % self._store)
    f = open(self._store,"r")
    obj = json.load(f)

    # convert json-object to settings
    keys = obj.keys()
    for key in keys:
      if key != "alarm":
        self._values[key] = obj[key]
      else:
        for a in obj[key]:
          alarm = Alarm(a)
          name = "alarm" + str(alarm.nr)
          self._values[name] = alarm
    f.close()

  # --- save settings   ----------------------------------------------------

  def save(self):
    self.log.msg("Saving settings to %s" % self._store)
    f = open(self._store,"w")
    jsonobj = {}
    for key in self._values.keys():
      if not key.startswith("alarm"):
        jsonobj[key] = self._values[key]

    # put alarms in a list
    alarms = []
    for key in ["alarm1","alarm2","alarm3","alarm4"]:
      alarms.append(self._values[key].toJSON())
    jsonobj["alarm"] = alarms

    json.dump(jsonobj,f,indent=2)
    f.close()

  # set a setting   --------------------------------------------------------

  def set(self,name,value):
    """ set a value """

    old_value = None
    if self._values.has_key(name):
      old_value = self._values[name]
      
    with self._lock:
      self._values[name] = value

    # call listeners
    if self._listeners.has_key(name):
      for listener in self._listeners[name]:
        listener(old_value,value)
    
    return old_value
    
  # query a setting   -------------------------------------------------------

  def get(self,name):
    """ query a value by name """

    if self._values.has_key(name):
      return self._values[name]
    else:
      return None

  # add settings listener   -------------------------------------------------

  def add_settings_listener(self,name,func):
    """ add a change-listener for attribute name """

    with self._lock:
      if self._listener.has_key(name):
        self._listener[name].append(func)
      else:
        self._listener[name] = [func]

  # add time-change listener   ----------------------------------------------

  def add_timechange_listener(self,func):
    """ add a change-listener for time changes """

    with self._lock:
      self.time_change_listener.append(func)
