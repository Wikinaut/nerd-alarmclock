#!/usr/bin/python
# --------------------------------------------------------------------------
# Class definition of TimeKeeperThread - this thread keeps track of time.
#
# Author: Bernhard Bablok
# License: GPL3
#
# Website: https://github.com/bablokb/nerd-alarmclock
#
# --------------------------------------------------------------------------

import time
from threading import Thread

class TimeKeeperThread(Thread):
  """ TimeKeeper thread """

  # constants   ------------------------------------------------------------

  POLL_INTERVAL  = 5

  # initialize object   ----------------------------------------------------

  def __init__(self,settings):
    """ Constructor """
    
    super(TimeKeeperThread,self).__init__(name="TimeKeeperThread")
    self._settings   = settings
    self._stop_event = settings.stop_event

  # run the thread   -------------------------------------------------------

  def run(self):
    self._settings.log.msg("running TimeKeeperThread")
    poll_int = TimeKeeperThread.POLL_INTERVAL
    old_time = [None,None]
    while True:
      if self._stop_event.wait(poll_int):
        break
      new_time = time.strftime("%Y:%m:%d %H:%M").split()
      if old_time[1] != new_time[1]:
        self._settings.set('_current_time',new_time[1])
      if old_time[0] != new_time[0]:
        self._settings.set('_current_date',new_time[0])
      old_time = new_time

      # set poll_int small enough so that we hit the minute-updates
      poll_int = min(60-time.localtime().tm_sec,TimeKeeperThread.POLL_INTERVAL)

    self._settings.log.msg("terminating TimeKeeperThread")
